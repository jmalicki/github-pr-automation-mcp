name: Security Audit (Optimized)

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]
  schedule:
    # Run comprehensive security audit weekly on Sundays at 2 AM UTC
    - cron: '0 2 * * 0'

jobs:
  security-audit-optimized:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 1  # Shallow clone sufficient for security checks
          
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '22'
          cache: 'npm'
          
      - name: Install dependencies
        run: npm ci
        
      - name: Parallel security audit (optimized)
        run: |
          echo "Running optimized parallel security audit..."
          
          # Run audit-ci and license-checker in parallel for 50%+ speed improvement
          (
            echo "üîç Running npm security audit..."
            npm run audit:ci:optimized
            echo "‚úÖ Security audit completed"
          ) &
          
          (
            echo "üìã Running license compliance check..."
            npm run license-check:optimized
            echo "‚úÖ License check completed"
          ) &
          
          # Wait for both processes to complete
          wait || exit 1
          
          echo "üéâ All security checks completed successfully!"
          
      - name: Security scan with CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: javascript
          
      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3

